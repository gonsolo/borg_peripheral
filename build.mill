//| mill-version: 1.1.2

// SPDX-FileCopyrightText: Â© 2025-2026 Andreas Wendleder
// SPDX-License-Identifier: CERN-OHL-S-2.0

import mill._
import mill.scalalib._
import mill.api.BuildCtx

trait BorgModule extends ScalaModule {
  def scalaVersion = "2.13.18"
  def chiselVersion = "7.9.0"

  override def mvnDeps = Task {
    super.mvnDeps() ++ Seq(
      mvn"org.chipsalliance::chisel:$chiselVersion"
    )
  }

  override def scalacPluginMvnDeps = Task {
    super.scalacPluginMvnDeps() ++ Seq(
      mvn"org.chipsalliance:::chisel-plugin:$chiselVersion"
    )
  }

  override def scalacOptions = Task {
    super.scalacOptions() ++ Seq(
      "-feature",
      "-language:reflectiveCalls",
      "-deprecation",
      "-Xcheckinit",
      "-Xsource:3"
    )
  }

  object test extends ScalaTests with TestModule.Utest {

    override def forkEnv = Task {
      super.forkEnv() ++ Map(
        "PROJECT_ROOT" -> BuildCtx.workspaceRoot.toString()
      )
    }

    override def mvnDeps = Task {
      super.mvnDeps() ++ Seq(
        mvn"com.lihaoyi::utest:0.9.5",
        mvn"com.lihaoyi::upickle:4.4.2",
        mvn"com.lihaoyi::os-lib:0.11.6"
      )
    }
  }
}

object borg extends BorgModule
